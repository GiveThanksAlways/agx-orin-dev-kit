# NixOS configurations for Jetson Orin AGX

Composable NixOS system configs. Pick a configuration at build time.

## Prerequisites

- Jetson Orin AGX with NixOS installed and UEFI firmware flashed
- SSH access or serial console
- Copy `hardware-configuration.nix` from your device (generated by `nixos-generate-config`)

## Configurations

| Config      | Command                                          | What it adds                                |
| ----------- | ------------------------------------------------ | ------------------------------------------- |
| Base        | `nixos-rebuild switch --flake .#nixos`           | DHCP networking, SSH, Jetpack               |
| Static IP   | `nixos-rebuild switch --flake .#nixos-static-ip` | Base + static IP on eth0                    |
| Performance | `nixos-rebuild switch --flake .#nixos-perf`      | Base + MAXN, locked clocks, hugepages, zram |
| llama.cpp   | `nixos-rebuild switch --flake .#nixos-llama-cpp` | Perf + llama.cpp server on :5000            |
| TabbyAPI    | `nixos-rebuild switch --flake .#nixos-tabby-api` | Perf + TabbyAPI server                      |
| Telemetry   | `nixos-rebuild switch --flake .#nixos-telemetry` | Base + Grafana/Prometheus/tegrastats        |

## Telemetry

The `nixos-telemetry` config enables a full observability stack:

- **tegrastats exporter** -- parses `tegrastats` output at 500ms intervals into Prometheus metrics
- **Prometheus** -- scrapes tegrastats + node-exporter, retains 30 days
- **Grafana** -- auto-provisioned dashboard at `http://<host>:3301`
- **Node exporter** -- CPU, memory, disk, network, thermal

Metrics collected:

| Metric                     | Source                               |
| -------------------------- | ------------------------------------ |
| GPU load %, frequency      | tegrastats (GR3D_FREQ)               |
| EMC load %, frequency      | tegrastats (EMC_FREQ)                |
| VIC, APE frequency         | tegrastats                           |
| Per-core CPU %, frequency  | tegrastats                           |
| RAM / SWAP usage           | tegrastats                           |
| Temperatures (all sensors) | tegrastats                           |
| Power per rail (mW)        | tegrastats (VDD_IN, CPU_GPU_CV, SOC) |
| System metrics             | node-exporter                        |

To view dashboards from your PC, see `../telemetry-viewer/`.

Optional: set `enableOpenTelemetry = true` for OTLP collector on ports 4317/4318/8889.

## Modules

| File                           | Purpose                                           |
| ------------------------------ | ------------------------------------------------- |
| `modules/performance.nix`      | MAXN power mode, locked clocks, hugepages, zram   |
| `modules/llama-cpp-server.nix` | llama.cpp systemd service with CUDA               |
| `modules/tabby-api.nix`        | TabbyAPI systemd service                          |
| `modules/telemetry.nix`        | Grafana + Prometheus + tegrastats telemetry stack |

## Customizing

Edit `configuration.nix` for user accounts, SSH keys, timezone, etc.
Edit `flake.nix` to compose modules differently or add new configurations.
